---
sourceId: managed:google_cloud
integrationDefinitionId: "${integration_definition_id}"
questions:
################################################################################
# Generic non-compliance questions
################################################################################
- id: integration-question-google-cloud-kubernetes-route-based-clusters
  title: Which Kubernetes clusters use Google Cloud Routes for traffic routing between pods?
  description:
    Finds all Kubernetes clusters that are routes-based clusters
  queries:
  - query: |
      FIND google_container_cluster WITH useRoutes = true
  tags:
  - google-cloud
  - gke
  - network
- id: integration-question-google-cloud-bucket-versioning-disabled
  title: Which Google Cloud storage buckets have versioning disabled?
  description:
    Finds all Google Cloud storage buckets with versioning disabled
  queries:
  - query: |
      FIND google_storage_bucket WITH versioningEnabled = false
  tags:
  - google-cloud
  - storage

- id: integration-question-google-iam-inactive-service-account
  title: Which Google Cloud service accounts are inactive?
  description:
    Finds all Google Cloud service accounts that are inactive
  queries:
  - query: |
      FIND google_iam_service_account WITH active = false
  tags:
  - google-cloud
  - iam

- id: integration-question-google-iam-active-service-account
  title: Which Google Cloud service accounts are active?
  description:
    Finds all Google Cloud service accounts that are active
  queries:
  - query: |
      FIND google_iam_service_account WITH active = true
  tags:
  - google-cloud
  - iam

- id: integration-question-google-iam-service-account-permissions
  title: Which permissions do my Google Cloud service accounts have?
  description:
    Finds all permissions for Google Cloud service accounts
  queries:
  - query: |
      FIND google_iam_service_account WITH email $= "gserviceaccount.com" as s
        (THAT ASSIGNED << AccessPolicy)?
        (THAT USES AccessRole)?
        THAT ASSIGNED << AccessPolicy AS p
        THAT ALLOWS >> *
      RETURN s.email, p.name, p.permissions, p.organization, p.folders, p.project
  tags:
  - google-cloud
  - iam

- id: integration-question-google-publish-subscribe-dead-letter-topic
  title: What settings are used to publish Google Cloud dead letter messages?
  description:
    Deliver a Google Cloud dead letter message using acknowledgement and retry settings.
  queries:
  - query: |
      FIND google_pubsub_topic 
        THAT USES google_pubsub_subscription AS p
      RETURN           
        p.deadLetter,p.ackDeadlineSeconds,p.isDefaultRetryPolicy
  tags:   
    - google-cloud
    - pubsub

- id: integration-question-google-cloud-function-deprecated-runtime
  title: Which Google Cloud Functions have runtime that are deprecated?
  description:
    Returns Google functions that are not using a supported runtime.
  queries:
  - name: bad
    query: |
       FIND google_cloud_function WITH runtime != (
        "nodejs16" OR
        "nodejs14" OR
        "nodejs12" OR
        "python39" OR
        "python38" OR
        "python37" OR
        "go116" OR
        "go113" OR
        "go111" OR
        "java17" OR
        "java11" OR
        "ruby30" OR
        "ruby27" OR
        "ruby26" OR
        "php74" OR
        "dotnet3")
  tags:
  - google-cloud
  - function
################################################################################
# End generic non-compliance questions
################################################################################

################################################################################
# Section 1: Identity and Access Management (IAM)
################################################################################
#1.1
- id: integration-question-google-cloud-corporate-login-credentials
  title: Ensure that corporate login credentials are used
  description:
    Use corporate login credentials instead of personal accounts, such as Gmail accounts.
  queries:
  - name: good
    query: find google_user with email $="@{{domain}}"
  - name: bad
    query: find google_user with email !$="@{{domain}}"
  tags:
  - google-cloud
  - user
  - access
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '1.1'

- id: integration-question-google-ske-enabled-for-admin-accounts
  title: Ensure that Security Key Enforcement is Enabled for All Admin Accounts
  description: >
    Setup Security Key Enforcement for Google Cloud Platform admin accounts.
  queries:
  - name: good
    query: |
      FIND google_user WITH admin = true OR isAdmin = true OR isDelegatedAdmin = true AND isEnforcedIn2Sv = true
  - name: bad
    query: |
      FIND google_user WITH admin = true OR isAdmin = true OR isDelegatedAdmin = true AND isEnforcedIn2Sv = true
  tags:
  - google-cloud
  - admin-account
  - security-key-enforcement
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '1.3'
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '1.3'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '1.3'

- id: integration-question-google-cloud-managed-service-account-keys
  title: Ensure that there are only GCP-managed service account keys for each service account
  description:
    User managed service accounts should not have user-managed keys.
  queries:
  - name: good
    query: find google_iam_service_account_key with type="SYSTEM_MANAGED"
  - name: bad
    query: find google_iam_service_account_key with type!="SYSTEM_MANAGED"
  tags:
  - google-cloud
  - service-account
  - access
  - iam
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '1.4'

- id: integration-question-google-cloud-service-account-non-admin
  title: Ensure that Service Account has no Admin privileges
  description:
    A service account should not have admin privileges
  queries:
  - name: good
    query: |
      find google_iam_service_account as user
        that ASSIGNED google_iam_binding
        that USES google_iam_role
        with name!~=(
          "admin" or
          "Admin"
        ) and name!=(
          "roles/owner" or
          "roles/editor"
        )
      return
        user.name,
        user.username,
        user.email,
        google_iam_role.name
  - name: bad
    query: |
      find google_iam_service_account as user
        that ASSIGNED google_iam_binding
        that USES google_iam_role
        with name~=(
          "admin" or
          "Admin"
        ) or name=(
          "roles/owner" or
          "roles/editor"
        )
      return
        user.name,
        user.username,
        user.email,
        google_iam_role.name
  tags:
  - google-cloud
  - service-account
  - admin
  - access
  - iam
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '1.5'

- id: integration-question-google-cloud-iam-not-assigned-user-token-roles-project-level
  title: Ensure that IAM users are not assigned the Service Account User or Service Account Token Creator roles at project level
  description: >
    It is recommended to assign the Service Account User (iam.serviceAccountUser)
    and Service Account Token Creator (iam.serviceAccountTokenCreator) roles to
    a user for a specific service account rather than assigning the role to a
    user at project level.
  queries:
  - name: good
    query: |
      FIND google_user AS user
        THAT ASSIGNED google_iam_binding
        THAT USES google_iam_role
          WITH (
            name != "roles/iam.serviceAccountUser" AND
            name != "roles/iam.serviceAccountTokenCreator"
          ) AS role
      RETURN
        user.username,
        role.name
  - name: bad
    query: |
      FIND google_user AS user
        THAT ASSIGNED google_iam_binding
        THAT USES google_iam_role
          WITH (
            name ="roles/iam.serviceAccountUser" OR
            name ="roles/iam.serviceAccountTokenCreator"
          ) AS role
      RETURN
        user.username,
        role.name
  tags:
  - google-cloud
  - service-account
  - access
  - iam
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '1.6'

- id: integration-question-google-cloud-user-managed-external-keys-service-account-rotation-period
  title: Ensure user-managed/external keys for service accounts are rotated every 90 days or less
  description: >
    Service Account keys consist of a key ID (Private_key_Id) and Private key,
    which are used to sign programmatic requests users make to Google cloud
    services accessible to that particular service account. It is recommended
    that all Service Account keys are regularly rotated.
  queries:
  - name: bad
    query: |
      find google_iam_service_account as serviceAccount
        that HAS google_iam_service_account_key
        with createdOn <= date.now-90days
      return
        serviceAccount.id,
        serviceAccount.email,
        serviceAccount.description,
        serviceAccount.enabled,
        serviceAccount.webLink,
        google_iam_service_account_key.name,
        google_iam_service_account_key.type,
        google_iam_service_account_key.createdOn,
        google_iam_service_account_key.expiresOn
  tags:
  - google-cloud
  - service-account
  - access
  - iam
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '1.7'

- id: integration-question-google-cloud-encryption-keys-publicly-accessible
  title: Are there Cloud KMS crypto keys that are publicly accessible?
  description: >
    It is recommended that the IAM policy on Cloud KMS cryptokeys should restrict anonymous and/or public access.
  queries:
  - name: good
    query: |
      find google_kms_crypto_key with public=false
  - name: bad
    query: |
      find google_kms_crypto_key with public=true
  tags:
  - google-cloud
  - kms
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '1.9'

- id: integration-question-google-cloud-encryption-keys-rotation-period
  title: Ensure encryption keys are rotated within a period of 365 days
  description: >
    Google Cloud Crypto keys should be rotated at least once per 365 days
  queries:
  - name: good
    query: |
      find google_kms_key_ring as keyRing
        THAT HAS google_kms_crypto_key as key
      where
        key.rotationPeriod <= 31536000
      return
        keyRing.name,
        keyRing.location,
        keyRing.webLink,
        key.name,
        key.displayName,
        key.createdOn,
        key.nextRotationTime,
        key.rotationPeriod,
        key.webLink
  - name: bad
    query: |
      find google_kms_key_ring as keyRing
        THAT HAS google_kms_crypto_key as key
      where
        key.rotationPeriod > 31536000
      return
        keyRing.name,
        keyRing.location,
        keyRing.webLink,
        key.name,
        key.displayName,
        key.createdOn,
        key.nextRotationTime,
        key.rotationPeriod,
        key.webLink
  tags:
  - google-cloud
  - kms
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '1.10'

- id: integration-question-google-cloud-iam-all-user-policies
  title: Which policies are bound to “allUsers” or “allAuthenticatedUsers”?
  description: >
    Return a list of GCP policies bound to certain all user groups.
  queries:
  - name: bad
    query: |
      FIND google_iam_binding WITH members = ("allUsers" OR "allAuthenticatedUsers")
  tags:
  - google-cloud
  - iam

- id: integration-question-google-cloud-policies-bound-to-users
  title: Which policies are bound to users?
  description: >
    Return a list of GCP policies bound to one or more users.
  queries:
  - name: good
    query: |
      FIND google_iam_binding WITH members ^="user:"
  tags:
  - google-cloud
  - iam

- id: integration-question-google-cloud-gke-kms-not-admin
  title: Which Google Cloud resources were provisioned with a KMS key that was not generated from the KMS admin project?
  description: >
    Return the GCP resources that were provisioned to use a KMS key that was not generated from the KMS admin project.
  queries:
  - name: bad
    query: |
      FIND (
        google_compute_disk |
        google_storage_bucket |
        google_bigquery_dataset |
        google_pubsub_topic |
        google_sql_mysql_instance |
        google_sql_postgres_instance |
        google_sql_sql_server_instance
      )
        WITH kmsKeyName !^="{{kms project reference}}"
        AND kmsKeyName != undefined AS result
      RETURN
        result.name,
        result.kmsKeyName,
        result.webLink
  tags:
  - google-cloud
  - gke
  - kms
################################################################################
# End section 1: Identity and Access Management (IAM)
################################################################################

################################################################################
# Section 2: Account Management
################################################################################
- id: integration-question-google-cloud-account-service-perimeter
  title: Which Google Cloud projects are not protected by a service perimeter?
  description: >
    Return a list of GCP projects that are not protected by a service perimiter.
  queries:
  - name: bad
    query: |
      FIND google_cloud_project
        THAT !PROTECTS google_access_context_manager_service_perimeter AS perimeter
        RETURN
          google_cloud_project.id, google_cloud_project.displayName, google_cloud_project.webLink
  tags:
  - google-cloud
  - account

- id: integration-question-google-cloud-api-services-service-perimeter
  title: Which Google Cloud API services are not limited by a service perimeter?
  description: >
    Return the GCP API services that are not limited by a service perimeter.
  queries:
  - name: bad
    query: |
      Find google_cloud_api_service
        THAT !LIMITS google_access_context_manager_service_perimeter as perimeter
        return
          google_cloud_api_service.name, google_cloud_api_service.displayName
  tags:
  - google-cloud
  - account
  - api
################################################################################
# End section 2: Account Management
################################################################################

################################################################################
# Section 3: Networking
################################################################################
- id: integration-question-google-cloud-default-network-not-exist
  title: Ensure that the default network does not exist in a project
  description: >
    To prevent use of default network, a project should not have a default network.
  queries:
  - name: bad
    query: find google_compute_network with name="default"
  tags:
  - google-cloud
  - compute
  - network
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '3.1'

- id: integration-question-google-cloud-dnssec-enabled-cloud-dns
  title: Are Domain Name System Security Extensions (DNSSEC) enabled for Cloud DNS?
  description: >
    Cloud Domain Name System (DNS) is a fast, reliable and cost-effective domain name system that powers millions of domains on the internet. Domain Name System Security Extensions (DNSSEC) in Cloud DNS enables domain owners to take easy steps to protect their domains against DNS hijacking and man-in-the-middle and other attacks.
  queries:
  - name: good
    query: find google_dns_managed_zone with dnssec="on"
  - name: bad
    query: find google_dns_managed_zone with dnssec!="on"
  tags:
  - google-cloud
  - domain
  - dns
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '3.3'

- id: integration-question-google-cloud-dns-dnssec-key-signing-key-insecure-algo
  title: Are my key-signing keys used in Cloud DNS DNSSEC using an insecure algorithm?
  description: >
    DNSSEC algorithm numbers in this registry may be used in CERT RRs. Zone signing (DNSSEC) and transaction security mechanisms (SIG(0) and TSIG) make use of particular subsets of these algorithms. The algorithm used for key signing should be a recommended one and it should be strong.
  queries:
  - name: good
    query: find google_dns_managed_zone with keySigningAlgorithm!="rsasha1"
  - name: bad
    query: find google_dns_managed_zone with keySigningAlgorithm="rsasha1"
  tags:
  - google-cloud
  - domain
  - dns
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '3.4'

- id: integration-question-google-cloud-dns-dnssec-zone-signing-key-insecure-algo
  title: Are my zone-signing keys used in Cloud DNS DNSSEC using an insecure algorithm?
  description: >
    DNSSEC algorithm numbers in this registry may be used in CERT RRs. Zone signing (DNSSEC) and transaction security mechanisms (SIG(0) and TSIG) make use of particular subsets of these algorithms. The algorithm used for key signing should be a recommended one and it should be strong.
  queries:
  - name: good
    query: find google_dns_managed_zone with zoneSigningAlgorithm!="rsasha1"
  - name: bad
    query: find google_dns_managed_zone with zoneSigningAlgorithm="rsasha1"
  tags:
  - google-cloud
  - domain
  - dns
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '3.5'

- id: integration-question-google-cloud-ssh-restricted-internet
  title: Ensure that SSH access is restricted from the internet
  description: >
    Firewall rules that allow traffic to SSH port (22) should be restricted
  queries:
  - name: bad
    query: |
      find Internet
        THAT ALLOWS as rule google_compute_firewall as firewall
        THAT PROTECTS google_compute_network as network
        THAT CONTAINS google_compute_subnetwork as subnetwork
      WHERE
        firewall.ingress=true AND
        rule.ipProtocol='tcp' AND
        rule.fromPort <= 22 AND
        rule.toPort >= 22
      return
        rule.ipProtocol,
          rule.fromPort,
          rule.toPort,
        firewall.sourceRanges,
          firewall.destinationRanges,
        network.displayName,
          network.name,
          network.description,
        subnetwork.CIDR,
          subnetwork.displayName,
          subnetwork.name
  tags:
  - google-cloud
  - compute
  - network
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '3.6'

- id: integration-question-google-cloud-rdp-restricted-internet
  title: Ensure that RDP access is restricted from the Internet
  description: >
    Firewall rules that allow traffic to RDP port (3389) should be restricted
  queries:
  - name: bad
    query: |
      find Internet
        THAT ALLOWS as rule google_compute_firewall as firewall
        THAT PROTECTS google_compute_network as network
        THAT CONTAINS google_compute_subnetwork as subnetwork
      WHERE
        firewall.ingress=true AND
        rule.ipProtocol='tcp' AND
        rule.fromPort <= 3389 AND
        rule.toPort >= 3389
      return
        rule.ipProtocol,
          rule.fromPort,
          rule.toPort,
        firewall.sourceRanges,
          firewall.destinationRanges,
        network.displayName,
          network.name,
          network.description,
        subnetwork.CIDR,
          subnetwork.displayName,
          subnetwork.name
  tags:
  - google-cloud
  - compute
  - network
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '3.7'

- id: integration-question-google-vpc-flow-logs-for-every-VPC-subnet
  title: Ensure that VPC Flow Logs is Enabled for Every Subnet in a VPC Network
  description: >
    Flow Logs is a feature that enables users to capture information about the IP traffic going to and from network interfaces in the organization's VPC Subnets. Once a flow log is created, the user can view and retrieve its data in Stackdriver Logging. It is recommended that Flow Logs be enabled for every business-critical VPC subnet.
  queries:
  - name: good
    query: |
      find google_compute_subnetwork WITH flowLogsEnabled = true
  - name: bad
    query: |
      find google_compute_subnetwork WITH flowLogsEnabled != true
  tags:
  - google-cloud
  - VPC-flowlogs
  - logging
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '3.8'
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '3.8'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '3.8'

- id: integration-question-google-IAP-allow-google-IP-addresses
  title: Use Identity Aware Proxy (IAP) to Ensure Only Traffic From Google IP Addresses are 'Allowed'
  description: >
    IAP authenticates the user requests to your apps via a Google single sign in. You can then manage these users with permissions to control access. It is recommended to use both IAP permissions and firewalls to restrict this access to your apps with sensitive information.
  queries:
  - name: good
    query: |
      find Service with displayName="Cloud Identity-Aware Proxy API" and enabled = true
  - name: bad
    query: |
      find Service with displayName="Cloud Identity-Aware Proxy API" and enabled != true
  tags:
  - google-cloud
  - google-IAP
  - Networking
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '3.10'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '3.10'

- id: integration-question-google-cloud-firewall-deny-all
  title: Which Google Cloud networks do not have a default Deny All egress rule for firewalls?
  description: >
    Return a list of GCP networks that do not have a default Deny All egress rule for firewalls.
  queries:
  - name: bad
    query: |
      FIND google_compute_network AS network
        THAT !HAS google_compute_firewall
          WITH denied ~= '{"IPProtocol":"all"}'
          AND egress = true
          AND destinationRanges ~= '0.0.0.0/0'
          AS firewall
      RETURN
        network.projectId,
        network.displayName,
        network.name,
        network.description
  tags:
  - google-cloud
  - network
  - firewall

- id: integration-question-google-cloud-firewall-remote-access
  title: Which compute instances in production projects have firewalls that allow remote user access?
  description: >
    Return instances in production projects with firewalls that allow remote user access.
  queries:
  - name: bad
    query: |
      FIND Internet
        THAT ALLOWS AS rule google_compute_firewall
          WITH ingress = true AS firewall
        THAT PROTECTS google_compute_network AS network
        THAT CONTAINS google_compute_subnetwork AS subnetwork
        THAT HAS google_compute_instance
          WITH projectId ~= 'prod' as instance
      WHERE (
          (rule.fromPort <= 3389 AND rule.toPort >= 3389) OR
          (rule.fromPort <= 22 AND rule.toPort >= 22) OR
          (rule.fromPort <= 5985 AND rule.toPort >= 5985) OR
          (rule.fromPort <= 5986 AND rule.toPort >= 5986)
      )
      RETURN
        instance.projectId, instance.displayName,
        firewall.name, firewall.priority,
        rule.ipRange,rule.fromPort, rule.toPort,
        network.displayName, network.name, network.description
  tags:
  - google-cloud
  - compute
  - network
  - firewall
################################################################################
# End section 3: Networking
################################################################################

################################################################################
# Section 4: Virtual Machines
################################################################################
- id: integration-question-google-cloud-compute-instance-non-default-service-account
  title: Ensure that Google Cloud Compute instances are not configured to use the default service account
  description: >
    It is recommended to configure your instance to not use the default Compute
    Engine service account because it has the Editor role on the project.
  queries:
  - name: bad
    query: |
      find google_compute_instance as instance
        that TRUSTS as trusts google_iam_service_account
        with email$="-compute@developer.gserviceaccount.com"
      return
        instance.id,
        instance.name,
        instance.displayName,
        instance.webLink,
        google_iam_service_account.name,
        google_iam_service_account.username,
        google_iam_service_account.email,
        trusts.scopes as serviceAccountScopes,
        google_iam_service_account.webLink
  tags:
  - google-cloud
  - compute
  - instance
  - service-account
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '4.1'

- id: integration-question-google-cloud-compute-instance-default-service-account-full-access
  title: Are any of my Google Compute instances using the default service account with full access to all cloud APIs?
  description: >
    To support principle of least privileges and prevent potential privilege escalation it is recommended that instances are not assigned to default service account Compute Engine default service account with Scope Allow full access to all Cloud APIs.
  queries:
  - name: good
    query: |
      find google_compute_instance with usesFullAccessDefaultServiceAccount!=true
  - name: bad
    query: |
      find google_compute_instance with usesFullAccessDefaultServiceAccount=true
  tags:
  - google-cloud
  - compute
  - instance
  - service-account
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '4.2'

- id: integration-question-google-cloud-compute-instance-block-project-wide-ssh-keys
  title: Is blocking of project-wide SSH keys enabled for my Google Cloud VM instances?
  description: >
    It is recommended to use Instance specific SSH key(s) instead of using common/shared project-wide SSH key(s) to access Instances.
  queries:
  - name: good
    query: |
      find google_compute_instance with blockProjectSSHKeys=true
  - name: bad
    query: |
      FIND google_compute_instance
      WITH blockProjectSSHKeys != true
      AND [tag.goog-gke-node] = undefined
      AND name !^= "gke-"
  tags:
  - google-cloud
  - compute
  - instance
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '4.3'

- id: integration-question-google-cloud-os-login-enabled-project
  title: Is OS login enabled for projects?
  description: >
    Enabling OS login binds SSH certificates to IAM users and facilitates effective SSH certificate management.
  queries:
  - name: good
    query: |
      find google_compute_project
        with isOSLoginEnabled=true
      that HAS google_compute_instance
        with isOSLoginEnabled!=false
      return
        google_compute_instance.id,
        google_compute_instance.name,
        google_compute_instance.displayName,
        google_compute_instance.webLink,
        google_compute_project.id,
        google_compute_project.displayName
  - name: bad
    query: |
      find google_compute_project as project
        that HAS google_compute_instance as instance
       where
        project.isOSLoginEnabled=false or
        (project.isOSLoginEnabled=true and instance.isOSLoginEnabled=false)
  tags:
  - google-cloud
  - compute
  - project
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '4.4'

- id: integration-question-google-cloud-vm-serial-port-connection-enabled
  title: Is connecting to serial ports enabled for VM instances?
  description: >
    Interacting with a serial port is often referred to as the serial console,
    which is similar to using a terminal window, in that input and output is
    entirely in text mode and there is no graphical interface or mouse support.

    If you enable the interactive serial console on an instance, clients can
    attempt to connect to that instance from any IP address. Therefore
    interactive serial console support should be disabled.
  queries:
  - name: good
    query: |
      find google_compute_instance with isSerialPortEnabled!=true
  - name: bad
    query: |
      find google_compute_instance with isSerialPortEnabled=true
  tags:
  - google-cloud
  - compute
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '4.5'

- id: integration-question-google-cloud-instance-ip-forwarding-not-enabled
  title: Is IP forwarding enabled on compute instances?
  description: >
    Compute Engine instance cannot forward a packet unless the source IP address
    of the packet matches the IP address of the instance. Similarly, GCP won't
    deliver a packet whose destination IP address is different than the IP
    address of the instance receiving the packet. However, both capabilities are
    required if you want to use instances to help route packets.

    Forwarding of data packets should be disabled to prevent data loss or
    information disclosure.
  queries:
  - name: good
    query: |
      find google_compute_instance with canIpForward!=true
  - name: bad
    query: |
      find google_compute_instance with canIpForward=true
  tags:
  - google-cloud
  - compute
  - network
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '4.6'

- id: integration-question-google-cloud-vm-disk-encrypted-customer-supplied-encryption-keys
  title: Are my VM disks encrypted with Customer-Supplied Encryption Keys (CSEK)?
  description: >
    Customer-Supplied Encryption Keys (CSEK) are a feature in Google Cloud Storage and Google Compute Engine. If you supply your own encryption keys, Google uses your key to protect the Google-generated keys used to encrypt and decrypt your data. By default, Google Compute Engine encrypts all data at rest. Compute Engine handles and manages this encryption for you without any additional actions on your part. However, if you wanted to control and manage this encryption yourself, you can provide your own encryption keys.
  queries:
  - name: good
    query: |
      find google_compute_disk with isCustomerSuppliedKeysEncrypted=true
  - name: bad
    query: |
      find google_compute_disk with isCustomerSuppliedKeysEncrypted!=true
  tags:
  - google-cloud
  - compute
  - encryption
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '4.7'

- id: integration-question-google-cloud-instances-shielded-vm-config
  title: Are my compute instances launched with shielded VM configuration?
  description: >
    To defend against against advanced threats and ensure that the boot loader and firmware on your VMs are signed and untampered, it is recommended that Compute instances are launched with Shielded VM enabled.
  queries:
  - name: good
    query: |
      find google_compute_instance with isShieldedVM=true
  - name: bad
    query: |
      find google_compute_instance with isShieldedVM!=true
  tags:
  - google-cloud
  - compute
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '4.8'

- id: integration-question-google-compute-instances-do-not-have-public-ips
  title: Ensure That Compute Instances Do Not Have Public IP Addresses
  description: >
    Compute instances should not be configured to have external IP addresses.
  queries:
  - name: good
    query: |
      FIND google_compute_instance with publicIpAddress = undefined
  - name: bad
    query: |
      FIND google_compute_instance with publicIpAddress != undefined
  tags:
  - google-cloud
  - virtual-machines
  - google-compute-instances
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '4.9'
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '4.9'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '4.9'

- id: integration-question-google-app-engine-enforce-https
  title: Ensure That App Engine Applications Enforce HTTPS Connections
  description: >
    In order to maintain the highest level of security all connections to an application should be secure by default.
  queries:
  - name: good
    query: |
      FIND google_app_engine_instance with encrypted = true
  - name: bad
    query: |
      FIND google_app_engine_instance with encrypted != true
  tags:
  - google-cloud
  - google-app-engine
  - https
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '4.10'
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '4.10'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '4.10'
################################################################################
# End Section 4: Virtual Machines
################################################################################

################################################################################
# Section 5: Storage
################################################################################
#5.1
- id: integration-question-google-cloud-storage-bucket-public-access
  title: Ensure that Cloud Storage bucket is not anonymously or publicly accessible
  description: >
    It is recommended that IAM policy on Cloud Storage bucket does not allow
    anonymous or public access.
  queries:
  - name: good
    query: find google_storage_bucket with public!=true
  - name: bad
    query: find google_storage_bucket with public=true and classification!='public'
  tags:
  - google-cloud
  - storage
  - access
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '5.1'
#5.2
- id: integration-question-google-cloud-storage-bucket-uniform-bucket-access-enabled
  title: Ensure that Cloud Storage buckets have uniform bucket-level access enabled
  description: >
    It is recommended to use uniform bucket-level access to unify and simplify
    how you grant access to your Cloud Storage resources.
  queries:
  - name: good
    query: find google_storage_bucket with uniformBucketLevelAccess=true
  - name: bad
    query: find google_storage_bucket with uniformBucketLevelAccess!=true
  tags:
  - google-cloud
  - storage
  - access
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '5.2'
################################################################################
# End Section 5: Storage
################################################################################

################################################################################
# Section 6: Cloud SQL Database Services
################################################################################
##MySql
#6.1.1
#6.1.2 v1.1 only
- id: integration-question-google-mysql-local-infile-flag-off
  title: Are my Cloud SQL MySQL instances configured with the "local_infile" database flag set to "off"?
  description: >
    It is recommended to set the local_infile database flag for a Cloud SQL MySQL instance to off.
  queries:
  - name: good
    query: |
      find google_sql_mysql_instance with localInfile='off'
  - name: bad
    query: |
      find google_sql_mysql_instance with localInfile!='off'
  tags:
  - google-cloud
  - sql
  - mysql
  - datastore
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.1.2'
#6.1.2 GCP v 1.3 and later
- id: integration-question-google-database-flag-skipshowdatabase
  title: Ensure "Skip_show_database" Database Flag for Cloud SQL MySQL Instance Is Set to "On"
  description: >
    It is recommended to set "skip_show_database" database flag for Cloud SQL Mysql instance to "on"
  queries:
  - name: good
    query: |
      find google_sql_mysql_instance WITH skipShowDatabase = 'on'
  - name: bad
    query: |
      find google_sql_mysql_instance WITH skipShowDatabase != 'on'
  tags:
  - google-cloud
  - database-flags
  - mysql
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.1.2'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.1.2'

#6.1.3
- id: integration-question-google-database-flag-localinfile
  title: Ensure That the "Local_infile" Database Flag for a Cloud SQL MySQL Instance Is Set to "Off"
  description: >
    It is recommended to set the `local_infile` database flag for a Cloud SQL MySQL instance to `off`.
  queries:
  - name: good
    query: |
      find google_sql_mysql_instance WITH localInfile = 'off'
  - name: bad
    query: |
      find google_sql_mysql_instance WITH localInfile != 'off'
  tags:
  - google-cloud
  - database-flags
  - mysql
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.1.3'
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.1.3'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.1.3'

##PostgreSQL
#6.2.1
- id: integration-question-google-postgresql-log-checkpoints-flag-on
  title: Are my Cloud PostgreSQL instances configured with the "log_checkpoints" database flag set to "on"?
  description: >
    Ensure that the log_checkpoints database flag for the Cloud SQL PostgreSQL instance is set to on.
  queries:
  - name: good
    query: |
      find google_sql_postgres_instance with logCheckpoints='on'
  - name: bad
    query: |
      find google_sql_postgres_instance with logCheckpoints!='on'
  tags:
  - google-cloud
  - sql
  - postgresql
  - datastore
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.2.1'

#6.2.1 v1.3 and later
- id: integration-question-google-database-flag-logerrorverbosity
  title: Ensure Log_error_verbosity Database Flag for Cloud SQL PostgreSQL Instance Is Set to DEFAULT or Stricter
  description: >
    The `log_error_verbosity` flag controls the verbosity/details of messages logged. Valid values are - `TERSE` - `DEFAULT` - `VERBOSE` `TERSE` excludes the logging of `DETAIL`, `HINT`, `QUERY`, and `CONTEXT` error information. `VERBOSE` output includes the `SQLSTATE` error code, source code file name, function name, and line number that generated the error. Ensure an appropriate value is set to 'DEFAULT' or stricter.
  queries:
  - name: good
    query: |
      find google_sql_postgres_instance with logErrorVerbosity = ('verbose' or 'terse' or 'default')
  - name: bad
    query: |
      find google_sql_postgres_instance with logErrorVerbosity != ('verbose' or 'terse' or 'default')
  tags:
  - google-cloud
  - database-flags
  - postgresql
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.2.1'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.2.1'

#6.2.2
- id: integration-question-google-postgresql-log-connections-flag-on
  title: Are my Cloud PostgreSQL instances configured with the "log_connections" database flag set to "on"?
  description: >
    Enabling the log_connections setting causes each attempted connection to the server to be logged, along with successful completion of client authentication. This parameter cannot be changed after the session starts.
  queries:
  - name: good
    query: |
      find google_sql_postgres_instance with logConnections='on'
  - name: bad
    query: |
      find google_sql_postgres_instance with logConnections!='on'
  tags:
  - google-cloud
  - sql
  - postgresql
  - datastore
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.2.2'

#6.2.3
- id: integration-question-google-postgresql-log-disconnections-flag-on
  title: Are my Cloud PostgreSQL instances configured with the "log_disconnections" database flag set to "on"?
  description: >
    Enabling the log_disconnections setting logs the end of each session, including the session duration.
  queries:
  - name: good
    query: |
      find google_sql_postgres_instance with logDisconnections='on'
  - name: bad
    query: |
      find google_sql_postgres_instance with logDisconnections!='on'
  tags:
  - google-cloud
  - sql
  - postgresql
  - datastore
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.2.3'

#6.2.4 v1.1 only 
- id: integration-question-google-postgresql-log-lock-awaits-flag-on
  title: Are my Cloud SQL PostgreSQL instances configured with the "log_lock_waits" database flag set to "on"?
  description: >
    Enabling the log_lock_waits flag for a PostgreSQL instance creates a log for any session waits that take longer than the alloted deadlock_timeout time to acquire a lock.
  queries:
  - name: good
    query: |
      find google_sql_postgres_instance with logLockWaits='on'
  - name: bad
    query: |
      find google_sql_postgres_instance with logLockWaits!='on'
  tags:
  - google-cloud
  - sql
  - postgresql
  - datastore
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.2.4'

#6.2.4 v1.3 and later
- id: integration-question-google-database-flag-logstatement
  title: Ensure Log_statement Database Flag for Cloud SQL PostgreSQL Instance Is Set Appropriately
  description: >
    The value of `log_statement` flag determined the SQL statements that are logged. Valid values are - `none` - `ddl` - `mod` - `all` The value `ddl` logs all data definition statements. The value `mod` logs all ddl statements, plus data-modifying statements. The statements are logged after a basic parsing is done and statement type is determined, thus this does not logs statements with errors. When using extended query protocol, logging occurs after an Execute message is received and values of the Bind parameters are included. A value of 'ddl' is recommended unless otherwise directed by your organization's logging policy.
  queries:
  - name: good
    query: |
      find google_sql_postgres_instance with logStatement = ('none' or 'mod' or 'ddl' or 'all')
  - name: bad
    query: |
      find google_sql_postgres_instance with logStatement != ('none' or 'mod' or 'ddl' or 'all')
  tags:
  - google-cloud
  - database-flags
  - postgresql
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.2.4'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.2.4'

#6.2.5
- id: integration-question-google-postgresql-log-min-messages-flag-on
  title: Are my Cloud PostgreSQL instances configured with the "log_min_messages" database flag set to an accetable value?
  description: >
    The log_min_error_statement flag defines the minimum message severity level
    that is considered as an error statement. Messages for error statements are
    logged with the SQL statement. Valid values include debug5, debug4, debug3,
    debug2, debug1, info, notice, warning, error, log, fatal, and panic.
    Each severity level includes the subsequent levels mentioned above.
  queries:
  - name: good
    query: |
      find google_sql_postgres_instance with logMinErrorStatement=('debug5' or 'debug4' or 'debug3' or 'debug2' or 'debug1' or 'info' or 'notice' or 'warning' or 'error' or 'log' or 'fatal' or 'panic')
  - name: bad
    query: |
      find google_sql_postgres_instance with logMinErrorStatement!=('debug5' or 'debug4' or 'debug3' or 'debug2' or 'debug1' or 'info' or 'notice' or 'warning' or 'error' or 'log' or 'fatal' or 'panic')
  tags:
  - google-cloud
  - sql
  - postgresql
  - datastore
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.2.5'
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.2.6'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.2.5'

#6.2.6 v1.1 only 
- id: integration-question-google-postgresql-log-temp-files-flag
  title: Are my Cloud PostgreSQL instances configured with the "log_temp_files" database flag set to "0"?
  description: >
    PostgreSQL can create a temporary file for actions such as sorting, hashing
    and temporary query results when these operations exceed work_mem. The
    log_temp_files flag controls logging names and the file size when it is
    deleted. Configuring log_temp_files to 0 causes all temporary file
    information to be logged, while positive values log only files whose size is
    greater than or equal to the specified number of kilobytes. A value of -1
    disables temporary file information logging.
  queries:
  - name: good
    query: |
      find google_sql_postgres_instance with logTempFiles='0'
  - name: bad
    query: |
      find google_sql_postgres_instance with logTempFiles!='0'
  tags:
  - google-cloud
  - sql
  - postgresql
  - datastore
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.2.6'

#6.2.7 v1.3 and 6.2.6 v2.0
- id: integration-question-google-database-flag-logminerrorstatement
  title: Ensure "Log_min_error_statement" Database Flag for Cloud SQL PostgreSQL Instance Is Set to "Error" or Stricter
  description: >
    The "log_min_error_statement" flag defines the minimum message severity level that are considered as an error statement. Messages for error statements are logged with the SQL statement. Valid values include 'DEBUG5', 'DEBUG4', 'DEBUG3', 'DEBUG2', 'DEBUG1', 'INFO', 'NOTICE', 'WARNING', 'ERROR', 'LOG', 'FATAL', and 'PANIC'. Each severity level includes the subsequent levels mentioned above. Ensure a value of `ERROR` or stricter is set. By default ERROR and lower is considered good, and all obove ERROR is considered bad. Set as definied by organization policy.  
  queries:
  - name: good
    query: |
      find google_sql_postgres_instance with logMinErrorStatement = ('debug5' or 'debug4' or 'debug3' or 'debug2' or 'debug1' or 'info' or 'notice' or 'warning' or 'error' or 'log' or 'fatal' or 'panic')
  - name: bad
    query: |
      find google_sql_postgres_instance with logMinErrorStatement != ('debug5' or 'debug4' or 'debug3' or 'debug2' or 'debug1' or 'info' or 'notice' or 'warning' or 'error' or 'log' or 'fatal' or 'panic')
  tags:
  - google-cloud
  - database-flags
  - postgresql
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.2.7'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.2.6'

#6.2.7
- id: integration-question-google-postgresql-log-min-duration-statement-flag
  title: Are my Cloud SQL MySQL instances configured with the "log_min_duration_statement" database flag set to "-1"?
  description: >
    The log_min_duration_statement flag defines the minimum amount of execution time of a statement in milliseconds where the total duration of the statement is logged. Ensure that log_min_duration_statement is disabled, i.e., a value of -1 is set.
  queries:
  - name: good
    query: |
      find google_sql_postgres_instance with logMinDurationStatement='-1'
  - name: bad
    query: |
      find google_sql_postgres_instance with logMinDurationStatement!='-1'
  tags:
  - google-cloud
  - sql
  - postgresql
  - datastore
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.2.7'
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.2.8'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.2.7'

#6.2.9 v1.3 and 6.2.8 v2.0
- id: integration-question-google-database-flag-cloudsql.enablepgaudit
  title: Ensure That "cloudsql.enable_pgaudit" Database Flag for each Cloud Sql Postgresql Instance Is Set to "on" For Centralized Logging
  description: >
    Ensure "cloudsql.enable_pgaudit" database flag for Cloud SQL PostgreSQL instance is set to "on" to allow for centralized logging.
  queries:
  - name: good
    query: |
      find google_sql_postgres_instance WITH cloudsql.enable_pgaudit = "on"
  - name: bad
    query: |
      find google_sql_postgres_instance WITH cloudsql.enable_pgaudit != "on"
  tags:
  - google-cloud
  - database-flags
  - postgresql
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.2.9'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.2.8'

#6.2.9 v2.0 and later

##sqlserver

#6.3.1 v1.3 and later
- id: integration-question-google-database-flag-externalscriptsenabled
  title: Ensure 'external scripts enabled' database flag for Cloud SQL SQL Server instance is set to 'off'
  description: >
    It is recommended to set 'external scripts enabled' database flag for Cloud SQL SQL Server instance to 'off'
  queries:
  - name: good
    query: |
      find google_sql_sql_server_instance WITH externalScriptsEnabled = "off"
  - name: bad
    query: |
      find google_sql_sql_server_instance WITH externalScriptsEnabled != "off"
  tags:
  - google-cloud
  - database-flags
  - sqlserver
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.3.1'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.3.1'

#6.3.2
- id: integration-question-google-sql-server-cross-db-ownership-chaining-flag
  title: Are my Cloud SQL Server instances configured with the "cross db ownership chaining" database flag set to "off"?
  description: >
    It is recommended to set cross db ownership chaining database flag for Cloud SQL SQL Server instance to off.
  queries:
  - name: good
    query: |
      find google_sql_sql_server_instance with crossDatabaseOwnershipChaining='off'
  - name: bad
    query: |
      find google_sql_sql_server_instance with crossDatabaseOwnershipChaining!='off'
  tags:
  - google-cloud
  - sql
  - sql-server
  - datastore
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.3.1'
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.3.2'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.3.2'

#6.3.3 v1.3 and later 
- id: integration-question-google-database-flag-userconnections
  title: Ensure 'User Connections' Database Flag for Cloud Sql Sql Server Instance Is Set to a Non-limiting Value
  description: >
    It is recommended to check the 'User Connections' for a Cloud SQL SQL Server instance to ensure that it is not artificially limiting connections. Set at >1, otherwise set to 0 for default. 
  queries:
  - name: good
    query: |
      find google_sql_sql_server_instance WITH userConnections <= 0
  - name: bad
    query: |
      find google_sql_sql_server_instance WITH userConnections > 0
  tags:
  - google-cloud
  - database-flags
  - sqlserver
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.3.3'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.3.3'

#6.3.4 v1.3 and later
- id: integration-question-google-database-flag-useroptions
  title: Ensure "user options" database flag for Cloud SQL SQL Server instance is not configured
  description: >
    It is recommended that, 'user options' database flag for Cloud SQL SQL Server instance should not be configured.
  queries:
  - name: bad
    query: |
      find google_sql_sql_server_instance WITH userOptions != undefined 
  tags:
  - google-cloud
  - database-flags
  - sqlserver
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.3.4'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.3.4'

#6.3.5 v1.3 and later 
- id: integration-question-google-database-flag-remoteaccess
  title: Ensure "remote access" database flag for Cloud SQL SQL Server instance is set to "off"
  description: >
    It is recommended to set "remote access" database flag for Cloud SQL SQL Server instance to "off".
  queries:
  - name: good
    query: |
      find google_sql_sql_server_instance WITH remoteAccess = "off" 
  - name: bad
    query: |
      find google_sql_sql_server_instance WITH remoteAccess != "off" 
  tags:
  - google-cloud
  - database-flags
  - sqlserver
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.3.5'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.3.5'

#6.3.6 v1.3 and later 
- id: integration-question-google-database-flag-traceflag
  title: Ensure "3625 (trace flag)" database flag for all Cloud SQL Server instances is set to "on"
  description: >
    It is recommended to set "3625 (trace flag)" database flag for Cloud SQL SQL Server instance to ON.
  queries:
  - name: good
    query: |
      find google_sql_sql_server_instance WITH traceFlag = "on"
  - name: bad
    query: |
      find google_sql_sql_server_instance WITH traceFlag != "on"
  tags:
  - google-cloud
  - database-flags
  - sqlserver
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.3.6'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.3.6'

#6.3.7
- id: integration-question-google-database-flag-containeddatabaseauthentication
  title: Ensure that the "contained database authentication" database flag for Cloud SQL on the SQL Server instance is set to "off"
  description: >
    It is recommended to set "contained database authentication" database flag for Cloud SQL on the SQL Server instance to OFF.
  queries:
  - name: good
    query: |
      find google_sql_sql_server_instance WITH containedDatabaseAuthentication = "off"
  - name: bad
    query: |
      find google_sql_sql_server_instance WITH containedDatabaseAuthentication != "off"
  tags:
  - google-cloud
  - database-flags
  - sqlserver
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.3.2'
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '6.3.7'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '6.3.7'

##cloudsql

#6.4
- id: integration-question-google-sql-require-ssl-incoming
  title: Are my Cloud SQL instances requiring SSL on all incoming connections?
  description: >
    It is recommended to enforce all incoming connections to SQL database instance to use SSL.
  queries:
  - name: good
    query: |
      find (google_sql_mysql_instance|google_sql_postgres_instance|google_sql_sql_server_instance)
        with requireSSL=true
  - name: bad
    query: |
      find (google_sql_mysql_instance|google_sql_postgres_instance|google_sql_sql_server_instance)
        with requireSSL!=true
  tags:
  - google-cloud
  - sql
  - datastore
  - network
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.4'

#6.5
- id: integration-question-google-sql-open-to-world
  title: Are my Cloud SQL instances open to the world?
  description: >
    Database servers should accept connections only from trusted Network(s)/IP(s) and restrict access from the world.
  queries:
  - name: good
    query: |
      find (google_sql_mysql_instance|google_sql_postgres_instance|google_sql_sql_server_instance)
        with authorizedNetworks!="0.0.0.0/0"
  - name: bad
    query: |
      find (google_sql_mysql_instance|google_sql_postgres_instance|google_sql_sql_server_instance)
        with authorizedNetworks="0.0.0.0/0"
  tags:
  - google-cloud
  - sql
  - datastore
  - network
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.5'

#6.6
- id: integration-question-google-sql-public-ips
  title: Do my Cloud SQL instances have public IP addresses?
  description: >
    It is recommended to configure Second Generation Sql instance to use private IPs instead of public IPs.
  queries:
  - name: good
    query: |
      find (google_sql_mysql_instance|google_sql_postgres_instance|google_sql_sql_server_instance)
        with hasPublicIP!=true
  - name: bad
    query: |
      find (google_sql_mysql_instance|google_sql_postgres_instance|google_sql_sql_server_instance)
        with hasPublicIP=true
  tags:
  - google-cloud
  - sql
  - datastore
  - network
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.6'

#6.7
- id: integration-question-google-sql-automated-backups
  title: Are my Cloud SQL instances configured with automated backups?
  description: >
    It is recommended to have all SQL database instances set to enable automated backups.
  queries:
  - name: good
    query: |
      find (google_sql_mysql_instance|google_sql_postgres_instance|google_sql_sql_server_instance)
        with automatedBackupsEnabled=true
  - name: bad
    query: |
      find (google_sql_mysql_instance|google_sql_postgres_instance|google_sql_sql_server_instance)
        with automatedBackupsEnabled!=true
  tags:
  - google-cloud
  - sql
  - datastore
  - network
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '6.7'
################################################################################
# End Section 6: Cloud SQL Database Services
################################################################################

################################################################################
# Section 7: BigQuery
################################################################################

#7.1
- id: integration-question-google-big-query-public
  title: Are any of my BigQuery datasets anonymously or publicly accessible?
  description: >
    It is recommended that the IAM policy on BigQuery datasets does not allow anonymous and/or public access.
  queries:
  - name: good
    query: |
      find google_bigquery_dataset with public=false
  - name: bad
    query: |
      find google_bigquery_dataset with public!=false
  tags:
  - google-cloud
  - big-query
  - datastore
  compliance:
  - standard: CIS Google Cloud Foundations 1.1
    requirements:
      - '7.1'

#7.2
- id: integration-question-google-bigquery-encrypt-tables-with-CMEK
  title: Ensure That All BigQuery Tables Are Encrypted With Customer-Managed Encryption Key (CMEK)
  description:
    BigQuery by default encrypts the data as rest by employing `Envelope Encryption` using Google managed cryptographic keys. The data is encrypted using the `data encryption keys` and data encryption keys themselves are further encrypted using `key encryption keys`. This is seamless and do not require any additional input from the user. However, if you want to have greater control, Customer-managed encryption keys (CMEK) can be used as encryption key management solution for BigQuery Data Sets. If CMEK is used, the CMEK is used to encrypt the data encryption keys instead of using google-managed encryption keys.
  queries:
  - name: good
    query: FIND google_bigquery_dataset WITH encrypted = true AND kmsKeyName ~= "cmek"
  - name: bad
    query: FIND google_bigquery_dataset WITH encrypted != true AND kmsKeyName ~= "cmek"
  tags:
  - google-cloud
  - bigquery
  - CMEK
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '7.2'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '7.2'

#7.3
- id: integration-question-google-bigquery-default-CMEK
  title: Ensure That a Default Customer-Managed Encryption Key (CMEK) Is Specified for All BigQuery Data Sets
  description:
    BigQuery by default encrypts the data as rest by employing `Envelope Encryption` using Google managed cryptographic keys. The data is encrypted using the `data encryption keys` and data encryption keys themselves are further encrypted using `key encryption keys`. This is seamless and do not require any additional input from the user. However, if you want to have greater control, Customer-managed encryption keys (CMEK) can be used as encryption key management solution for BigQuery Data Sets.
  queries:
  - name: good
    query: Find google_bigquery_dataset WITH kmsKeyName ~= "cmek"
  - name: bad
    query: Find google_bigquery_dataset WITH kmsKeyName !~= "cmek"
  tags:
  - google-cloud
  - bigquery
  - CMEK
  compliance:
  - standard: CIS Google Cloud Platform Foundation Benchmark 1.3
    requirements:
      - '7.3'
  - standard: CIS Google Cloud Platform Foundation Benchmark 2.0.0
    requirements:
      - '7.3'
################################################################################
# End Section 7: Big Query
################################################################################

################################################################################
# Section 7: Kubernetes
################################################################################
- id: integration-question-google-cloud-gke-instance-disks-cos
  title: Which Google Cloud GKE Clusters created compute instances that use disks, which are not provisioned with a COS image?
  description: >
    Return the GCP Google Kubernetes Engine clusters that created an instance using disks that are not provisioned wih a container optomized OS image.
  queries:
  - name: bad
    query: |
      FIND google_container_cluster
        THAT HAS google_container_node_pool
        THAT HAS google_compute_instance_group
        THAT HAS google_compute_instance
        THAT USES google_compute_disk
        THAT USES google_compute_image
          WITH family !^="cos-"
        RETURN
          google_compute_instance.projectId,
          google_container_cluster.id,
          google_container_cluster.webLink,
          google_compute_instance.id,
          google_compute_instance.displayName,
          google_compute_image.description,
          google_compute_instance.webLink,
          google_compute_image.id,
          google_compute_image.displayName,
          google_compute_image.description,
          google_compute_image.family,
          google_compute_image.webLink
  tags:
  - google-cloud
  - gke
  - compute
  - image

- id: integration-question-google-cloud-gke-instance-no-shielding-vm
  title: Which Google Cloud GKE Clusters created compute instances without shielding VMs?
  description: >
    Return the GCP Google Kubernetes Engine clusters that created an instance without shielding virtual machines.
  queries:
  - name: bad
    query: |
      FIND google_container_cluster
        THAT HAS google_container_node_pool
        THAT HAS google_compute_instance_group
        THAT HAS google_compute_instance
          WITH isShieldedVM!=true
        RETURN
          google_compute_instance.projectId,
          google_container_cluster.id,
          google_container_cluster.webLink,
          google_compute_instance.id,
          google_compute_instance.displayName,
          google_compute_instance.description,
          google_compute_instance.webLink,
          google_compute_instance.integrityMonitoringEnabled,
          google_compute_instance.secureBootEnabled,
          google_compute_instance.vtpmEnabled
  tags:
  - google-cloud
  - gke
  - compute
  - virtual-machine

- id: integration-question-google-cloud-gke-kms-compute-multiple-network
  title: Which Google Cloud GKE Clusters created compute instances that are connected to more than one network?
  description: >
    Return the GCP Google Kubernetes Engine clusters that created an instance that are connected to more than a single network.
  queries:
  - name: bad
    query: |
      FIND google_container_cluster
        THAT HAS google_container_node_pool
        THAT HAS google_compute_instance_group
        THAT HAS google_compute_instance
          WITH connectedNetworksCount > 1
        THAT HAS google_compute_subnetwork
        return
          google_compute_instance.projectId,
          google_container_cluster.id,
          google_container_cluster.webLink,
          google_compute_instance.id,
          google_compute_instance.displayName,
          google_compute_instance.description,
          google_compute_instance.webLink,
          google_compute_subnetwork.name,
          google_compute_subnetwork.displayName,
          google_compute_subnetwork.description,
          google_compute_subnetwork.webLink
  tags:
  - google-cloud
  - gke
  - compute
  - network

- id: integration-question-google-cloud-gke-instance-not-default
  title: Which Google Cloud GKE Clusters created compute instances that do not use the default subnet?
  description: >
    Return the GCP Google Kubernetes Engine clusters that created an instance that is not using the default subnet.
  queries:
  - name: bad
    query: |
      find google_container_cluster
        THAT HAS google_container_node_pool
        THAT HAS google_compute_instance_group
        THAT HAS google_compute_instance
        THAT HAS google_compute_subnetwork
          with name!="{{subnetwork name}}"
        return
          google_compute_instance.projectId,
          google_container_cluster.id,
          google_container_cluster.webLink,
          google_compute_instance.id,
          google_compute_instance.displayName,
          google_compute_instance.description,
          google_compute_instance.webLink,
          google_compute_subnetwork.name,
          google_compute_subnetwork.displayName,
          google_compute_subnetwork.description,
          google_compute_subnetwork.webLink
  tags:
  - google-cloud
  - gke
  - compute
  - network
################################################################################
# End Section 7: Kubernetes
################################################################################
